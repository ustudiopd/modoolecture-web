아래 문서는 **“회차별 이벤트 페이지 구축 → 질문 수집(직접+엑셀) → 답변 시스템(수동 생성+Novel 편집) → 어드민에서 OBS 송출용 방송 화면 출력”**까지 한 번에 연결되는 **전체 명세서(구현용)**입니다.
현재 만들어둔 프로토타입 UI를 그대로 제품화하는 방향으로 작성했고, 질문 보드 UI는 `qna.html`의 검색/정렬/카테고리/토스트/카드 구조를 기준으로  , 방송 화면은 `pregentation.html`의 ON AIR/진행표시/좌우 이동/Space 공개(블러 해제)/Gemini-GPT 분할 카드 뷰를 기준으로   작성했습니다.

---

# 모두의특강 웹 플랫폼 리뉴얼 전체 명세서 v1.30 (Cursor 구현용)

> **업데이트 내역 (v1.30)**
> * 라우팅 구조를 현재 코드베이스에 맞게 수정 (`/board/[event]`)
> * 투표 시스템을 좋아요 시스템으로 변경 (`modu_likes`, `like_count`)
> * 프롬프트 복사 버튼을 "Copy for LLM" 1개로 통일
> * Next.js 버전을 16+로 업데이트

## 1. 프로젝트 개요

### 1.1 목표

* Wix 기반 정적 페이지를 **Next.js(App Router) + Supabase** 기반의 동적 플랫폼으로 전환
* 매 회차(event)마다 **질문 무제한(200~500+) 수집/관리**
* 질문은 **직접 입력** + **엑셀 업로드 후 Gemini 전처리(청킹/분류/태그)**로 자동 등록
* 답변은 비용 절감을 위해 **Gemini/ChatGPT API로 생성하지 않음**
  → 대신 **프롬프트 복사 버튼**으로 운영자가 브라우저에서 직접 생성 후 붙여넣기
* 관리자 페이지에서 **OBS 송출용 방송 페이지(프롬프터 화면) 출력 + 실시간 제어 워크플로우** 구축

### 1.2 핵심 가치

* **One-Source Multi-Use**: 질문 DB 하나로 **홈페이지/방송/아카이브** 동시 대응
* **회차(event) 기준 완전 분리**: 데이터/랭킹/방송 상태가 섞이지 않음

---

## 2. 사용자 역할과 권한

### 2.1 Public(일반 사용자)

* 회차별 질문 보드 열람
* 좋아요
* (옵션) 이벤트가 open일 때 질문 제출(사연형)

### 2.2 Admin(운영진)

* 회차 생성/편집/상태 변경(open/live/closed)
* 질문 등록(직접 입력)
* 엑셀 업로드 → Gemini 전처리 → 자동 등록
* 질문 편집(제목/본문/카테고리/태그/작성자명 마스킹/방송용 정리)
* 답변 입력/편집:

  * **Gemini 답변**(Novel Editor)
  * **GPT 답변**(Novel Editor)
  * (옵션) 전문가 답변( Novel Editor )
* 유사 질문 **수동 묶기(그룹핑)**
* 방송 순서 편집 + 방송 상태 제어(다음/이전/공개)
* OBS 송출용 방송 화면 새 창 출력

---

## 3. 이벤트(회차) 라이프사이클 규칙

### 3.1 status

* `open`: 질문 제출(옵션) + 좋아요 가능
* `live`: 좋아요 가능, 질문 제출은 옵션(기본 OFF 추천)
* `closed`: 읽기 전용(좋아요/제출 불가)

이벤트 스키마/상태 개념은 기존 명세의 `modu_events.status(open|live|closed)`를 따른다 .

---

## 4. 데이터 흐름(End-to-End)

```mermaid
graph LR
  A[Admin: 직접입력] --> B[(Supabase DB)]
  A2[Admin: Excel 업로드] --> C[Gemini 전처리(청킹/분류)] --> B
  B --> D[Public: 회차별 질문 보드]
  D -->|like| B
  B --> E[Admin: 질문/답변/그룹 관리]
  E -->|방송 제어 상태 업데이트| F[(broadcast_state)]
  F -->|Realtime 구독| G[Broadcast Stage View (OBS)]
  E -->|팝업 오픈| G
```

---

## 5. 기술 스택

* Next.js 16+ (App Router)
* TypeScript
* Tailwind CSS
* Supabase(Postgres + Auth + Realtime)
* Novel.sh 에디터(답변 작성; 기존 명세에서도 Novel 기반 운영을 전제 )
* 엑셀 파싱: `xlsx` 또는 `exceljs`
* (권장) 상태/단축키:

  * Zustand, react-hotkeys-hook
* (권장) 드래그&드롭:

  * dnd-kit

---

## 6. 라우팅(정보 구조)

### 6.1 Public

* `/` : 메인 페이지 (회차 목록 포함 가능)
* `/board/[event]` : 회차 질문 보드 (리스트/카드/그룹핑 토글)
* `/board/[event]/[questionId]` : 질문 상세(답변 탭 포함)
* (옵션) `/board/[event]/write` : 질문 제출(사연형)

### 6.2 Admin

* `/admin/login`
* `/admin/events` : 회차 목록/생성/편집
* `/admin/events/[eventId]/questions` : 질문 관리(등록/업로드/그룹핑/정렬)
* `/admin/questions/[questionId]` : 질문 상세 편집 + 답변 편집(2개 에디터)
* `/admin/broadcast/[eventId]/control` : 방송 제어(키보드/버튼)

### 6.3 Broadcast (OBS)

* `/broadcast/[eventId]` : 송출용 Stage View (헤더/푸터 없음, 풀스크린)

> 방송 화면 UI 기준: ON AIR/진행표시 , 좌/우 이동 & Space 공개(블러 해제) 

---

## 7. DB 스키마(핵심)

> 기존 기본 테이블 구조는 `modu_events`, `modu_questions`, `modu_likes`를 유지하고 확장한다 .

### 7.1 modu_events (회차)

기존 명세와 동일 

* `id uuid PK`
* `slug text UNIQUE`
* `title text`
* `event_date timestamptz`
* `status text (open|live|closed)`
* `notebooklm_url text` (qna.html 헤더의 NotebookLM 버튼 컨셉과 연결 )

### 7.2 modu_raw_responses (엑셀/사전설문 원본 보관)

**목적**: 이름/이메일/원문을 안전하게 보관하되, 공개용 질문과 분리

```sql
CREATE TABLE IF NOT EXISTS modu_raw_responses (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL REFERENCES modu_events(id) ON DELETE CASCADE,
  row_no INTEGER,                 -- 엑셀 '순서'
  submitted_at TIMESTAMPTZ,       -- 엑셀 '신청일시'
  display_name_raw TEXT,          -- 엑셀 '이름'
  email TEXT,                     -- 엑셀 '이메일' (RLS로 admin만)
  raw_text TEXT NOT NULL,         -- 엑셀 'AI 활용 관련...'
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(event_id, row_no)
);
```

> 업로드 파일 컬럼 예시는 실제 엑셀에서 `순서/신청일시/이름/이메일/AI 활용 관련 궁금한점 이나 불편한점?` 형태로 존재함(전처리 매핑 기준).

### 7.3 modu_questions (공개용 “원자 질문”)

기존 `modu_questions`에 확장 컬럼 추가(기본 구조는 명세 동일 )

추가/변경 포인트:

* 질문은 500개 이상 가능 → 검색/정렬/그룹핑/페이지네이션 필수
* AI 답변은 2슬롯(직접 붙여넣기)

```sql
ALTER TABLE modu_questions
  ADD COLUMN IF NOT EXISTS raw_response_id UUID REFERENCES modu_raw_responses(id) ON DELETE SET NULL,
  ADD COLUMN IF NOT EXISTS display_name_raw TEXT,
  ADD COLUMN IF NOT EXISTS display_name_masked TEXT,

  ADD COLUMN IF NOT EXISTS tags TEXT[] DEFAULT '{}',
  ADD COLUMN IF NOT EXISTS seq INTEGER,
  ADD COLUMN IF NOT EXISTS sort_order INTEGER DEFAULT 0,

  ADD COLUMN IF NOT EXISTS answer_gemini TEXT,
  ADD COLUMN IF NOT EXISTS answer_gpt TEXT;

-- vote_count를 like_count로 변경 (기존 컬럼이 있다면)
ALTER TABLE modu_questions
  RENAME COLUMN IF EXISTS vote_count TO like_count;
```

**주의**: 좋아요 필드는 `like_count`를 사용한다. 기존 `vote_count`가 있다면 마이그레이션으로 변경.

### 7.4 modu_likes (좋아요)

기존 투표 시스템을 좋아요로 변경:

```sql
CREATE TABLE IF NOT EXISTS modu_likes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  question_id UUID REFERENCES modu_questions(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id),  -- 로그인 유저 (nullable)
  session_id TEXT,                         -- 비로그인 유저 (브라우저 세션)
  created_at TIMESTAMPTZ DEFAULT now(),
  UNIQUE(question_id, user_id),            -- 회원 중복 방지
  UNIQUE(question_id, session_id)          -- 비회원 중복 방지
);

CREATE INDEX IF NOT EXISTS modu_idx_likes_question ON modu_likes(question_id);
CREATE INDEX IF NOT EXISTS modu_idx_likes_user ON modu_likes(user_id);
CREATE INDEX IF NOT EXISTS modu_idx_likes_session ON modu_likes(session_id);
```

기존 명세 유지(중복 방지 + like_count 증가) 

### 7.5 modu_question_groups / modu_question_group_items (유사 질문 그룹핑)

**목적**: 유사 질문을 자동/수동으로 묶고, 보드/방송에서는 “그룹(대표 질문)” 단위로 볼 수 있게 함.

```sql
CREATE TABLE IF NOT EXISTS modu_question_groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  event_id UUID NOT NULL REFERENCES modu_events(id) ON DELETE CASCADE,

  title TEXT NOT NULL,                 -- 그룹 대표 제목
  category TEXT,
  tags TEXT[] DEFAULT '{}',

  canonical_question_id UUID REFERENCES modu_questions(id) ON DELETE SET NULL,
  sort_order INTEGER DEFAULT 0,        -- 방송/보드 정렬 기준

  item_count INTEGER DEFAULT 0,        -- 캐시(트리거로 관리 가능)
  like_sum INTEGER DEFAULT 0,          -- 캐시(옵션)

  status TEXT DEFAULT 'active',        -- active|hidden|merged
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE IF NOT EXISTS modu_question_group_items (
  group_id UUID REFERENCES modu_question_groups(id) ON DELETE CASCADE,
  question_id UUID REFERENCES modu_questions(id) ON DELETE CASCADE,
  similarity REAL,
  created_at TIMESTAMPTZ DEFAULT now(),
  PRIMARY KEY (group_id, question_id)
);

CREATE INDEX IF NOT EXISTS modu_idx_group_event_sort ON modu_question_groups(event_id, sort_order);
CREATE INDEX IF NOT EXISTS modu_idx_group_items_question ON modu_question_group_items(question_id);
```

> MVP에서는 “수동 그룹핑” 중심. 자동 유사도(임베딩/텍스트 유사도)는 추후 추가 가능.

### 7.6 modu_broadcast_state (방송 진행 상태: 이벤트당 1행)

Stage View는 이 상태를 구독해 렌더한다.
프로토타입의 `currentIndex`, `isRevealed` 개념을 DB로 올리는 형태 .

```sql
CREATE TABLE IF NOT EXISTS modu_broadcast_state (
  event_id UUID PRIMARY KEY REFERENCES modu_events(id) ON DELETE CASCADE,
  current_group_id UUID REFERENCES modu_question_groups(id) ON DELETE SET NULL,
  current_index INTEGER DEFAULT 0,
  reveal_mode TEXT DEFAULT 'hidden' CHECK (reveal_mode IN ('hidden','gpt','gemini','both')),
  updated_at TIMESTAMPTZ DEFAULT now()
);
```

---

## 8. RLS/보안/개인정보

### 8.1 공개 테이블

* `modu_events`: 공개 SELECT 가능(일반)
* `modu_questions`: 공개 SELECT 가능(일반)
* `modu_question_groups`: 공개 SELECT 가능(일반)
* `modu_likes`: insert 공개(세션 기반), select는 제한(기존 정책 참고)

### 8.2 민감 테이블(관리자만)

* `modu_raw_responses`: email 포함 → admin만 SELECT
* 관리자 전용 API는 service-role key 서버에서만 사용

### 8.3 이름 정책

* `display_name_raw` 저장(요청사항)
* public 노출은 기본 `display_name_masked` 사용
* 마스킹 함수는 서버에서 deterministic하게 생성(예: 홍길동→홍*동)

---

## 9. API 명세 (핵심 엔드포인트)

### 9.1 Public

#### 이벤트 목록/상세

* `GET /api/events`
* `GET /api/events/[slug]`

#### 질문/그룹 조회

* `GET /api/board?event=...&view=group|question&sort=hot|new|answered&category=...&q=...&page=1&limit=20`

정렬/필터/페이지네이션 패턴은 기존 getQuestions 로직을 따른다( event_id 필터 + like_count 정렬 등).

#### 좋아요

* `POST /api/like`

  * body: `{ question_id, session_id }`
  * 내부에서 `modu_increment_like_count` RPC 호출 또는 직접 업데이트 

### 9.2 Admin

#### 이벤트 관리

* `POST /api/admin/events`
* `PUT /api/admin/events/[id]`

#### 질문 직접 입력

* `POST /api/admin/questions`
* `PUT /api/admin/questions/[id]`
* `DELETE /api/admin/questions/[id]`

#### 답변 저장(2슬롯 + Novel markdown)

* `PUT /api/admin/questions/[id]/answers`

  * body: `{ answer_gemini, answer_gpt, answer_expert? }`

#### 엑셀 업로드 + Gemini 전처리 등록

* `POST /api/admin/upload/excel?eventId=...`

  * multipart/form-data
  * 서버가 엑셀 파싱 → raw_responses 저장 → Gemini-2.0-flash 배치 전처리 → questions upsert

#### 그룹핑(수동)

* `POST /api/admin/groups` (새 그룹 생성 + question_ids 연결)
* `POST /api/admin/groups/add-items`
* `POST /api/admin/groups/remove-items`
* `PUT /api/admin/groups/set-canonical`
* `POST /api/admin/groups/merge`

#### 방송 제어

* `GET /api/admin/broadcast/state?eventId=...`
* `PUT /api/admin/broadcast/state`

  * `{ eventId, current_index?, current_group_id?, reveal_mode? }`

---

## 10. Gemini 전처리(엑셀 → 청킹/분류/태그) 명세

### 10.1 입력 엑셀 매핑(기본 지원)

업로드 파일은 다음 컬럼을 기본으로 지원:

* `순서` → row_no
* `신청일시` → submitted_at
* `이름` → display_name_raw
* `이메일` → email
* `AI 활용 관련 궁금한점 이나 불편한점?` → raw_text

### 10.2 전처리 결과 스키마

서버는 raw_text를 최대 3개 원자 질문으로 분해하여 `modu_questions`로 저장:

* title(요약)
* content(원문 또는 정규화 질문)
* category
* tags[]
* display_name_raw/masked
* raw_response_id 링크

### 10.3 배치 처리

* 25개 단위로 Gemini 호출(레이트리밋 대비)
* 실패 row는 재시도(최대 2회) 후 “failed”로 로그 저장

> (중요) **AI 답변 생성은 하지 않음.** 전처리는 “분류/청킹”만.

---

## 11. UI/UX 상세 스펙

## 11.1 질문 보드 `/board/[event]`

qna.html UX를 그대로 React화:

* Toast 컨테이너 
* 검색/정렬/카테고리 영역 
* 카드 그리드 렌더 

### 11.2.1 상단 툴바(Sticky)

* Search input
* Sort select: hot/new/answered (프로토타입 옵션 구조 동일) 
* Category chips(스크롤) 
* View Toggle: **List / Cards**
* Mode Toggle: **Grouped / Ungrouped**
* Admin only: **편집모드(ON/OFF)**

### 11.2.2 카드 뷰(Cards)

* 기본 질문 카드 UI는 qna.html 컨셉 유지
* 카드 액션:

  * 👍 좋아요
  * 📋 프롬프트 복사: "Copy for LLM"
  * (옵션) 상세 링크

### 11.2.3 리스트 뷰(List)

* 운영/정리에 최적화된 테이블형 리스트
* Admin 편집모드 ON 시 체크박스 표시 + 다중 선택

### 11.2.4 프롬프트 복사 동작(브라우저-only)

* API 호출 없음
* `navigator.clipboard.writeText()`로 복사 (qna.html의 복사 패턴 동일)
* "Copy for LLM" 버튼 1개로 통일 (GPT/Gemini 구분 없이 범용 프롬프트)
* Toast로 안내(qna.html처럼 "복사 완료") 

---

## 11.3 질문 상세 `/admin/questions/[questionId]` (관리자)

### 레이아웃

* 좌측: 질문 정보(제목/본문/카테고리/태그/작성자명/마스킹/그룹)
* 우측: 답변 편집 탭

  * Tab 1: Gemini 답변(Novel Editor)
  * Tab 2: GPT 답변(Novel Editor)
  * Tab 3(옵션): 전문가 답변(Novel Editor)

### 상단 버튼

* “Copy for LLM” (범용 프롬프트 복사)
* “방송용 문장으로 다듬기(옵션: Gemini 전처리 재실행)”

---

## 11.4 유사 질문 수동 묶기 UI (Admin: `/admin/events/[eventId]/questions`)

### 요구사항: 리스트형 + 카드형 둘 다 지원 + 수동 그룹핑

* 리스트/카드 토글은 “렌더 방식만 변경”, 데이터는 동일
* Grouped 모드에서는 **그룹 카드/행**을 보여주고 펼치면 멤버 질문 리스트 표시
* Ungrouped 모드에서는 모든 질문을 개별로 표시

### 편집모드 ON 시 공통 UX

* 체크박스(다중선택)
* 상단/하단에 “선택된 항목 N개” 액션 바

#### 액션 바 버튼

* `새 그룹으로 묶기`
* `기존 그룹에 추가`
* `그룹에서 빼기`
* `대표 질문 지정`
* `그룹 병합`
* `선택 해제`

#### “새 그룹으로 묶기” 모달

* 그룹 제목(자동 제안 + 수정)
* 대표 질문 선택(선택된 질문 중 1개)
* 카테고리/태그 수정
* 저장

#### “기존 그룹에 추가” 패널

* 그룹 검색(제목/태그)
* 최근 그룹 목록
* 선택 후 추가

---

## 11.5 방송 송출 화면 `/broadcast/[eventId]` (OBS)

pregentation.html을 React로 이식:

* ON AIR + 행사명 + 진행표시 
* 상단에 카테고리/질문번호 표시 
* Gemini/GPT 2컬럼 카드 
* 답변 기본 블러 상태 → 공개 시 blur 해제 & 카드 활성 애니메이션 

### Stage View 원칙

* **읽기 전용**(키보드 입력 비활성 추천)
* DB의 `modu_broadcast_state` + 현재 `modu_question_groups`/canonical question을 구독(Realtime)
* reveal_mode에 따라:

  * hidden: 둘 다 blur
  * gpt: GPT만 공개
  * gemini: Gemini만 공개
  * both: 둘 다 공개

---

## 11.6 방송 제어 화면 `/admin/broadcast/[eventId]/control`

### 목적

* 운영진이 키보드로 넘기되, **OBS 창 포커스 사고 방지**
* Stage View와 분리 운영

### 키보드 매핑(프로토타입 동작 기반)

* `→` 다음
* `←` 이전
* `Space` 공개 토글(프로토타입 Space 공개 컨셉 동일) 
* `ESC` 그룹/질문 썸네일 목록 토글(선택)

### UI

* 현재 그룹/대표 질문 미리보기
* 다음/이전 버튼
* reveal_mode 버튼(hidden/gpt/gemini/both)
* 방송 순서 리스트(sort_order 드래그&드롭)

---

## 12. OBS 송출 워크플로우(관리자)

Admin 이벤트 페이지에 버튼:

* `[📺 방송 화면 열기]` → `/broadcast/${eventId}` 팝업 오픈(1920x1080 권장)
* `[🎛 방송 제어 열기]` → `/admin/broadcast/${eventId}/control`

---

## 13. 폴더 구조(권장)

기존 명세의 App Router 구조 패턴을 참고하되 , 이번 프로젝트는 site/admin/broadcast로 분리:

```
app/
├── board/
│   └── [event]/
│       ├── page.tsx
│       └── [questionId]/
│           └── page.tsx
├── admin/
│   ├── login/page.tsx
│   ├── events/page.tsx
│   ├── events/[eventId]/questions/page.tsx
│   ├── questions/[questionId]/page.tsx
│   └── broadcast/[eventId]/control/page.tsx
├── broadcast/
│   └── [eventId]/page.tsx
└── api/
    ├── like/route.ts
    └── ...
```

---

## 14. 구현 단계(권장 Phase)

> 구현 계획 문서 형식은 plan.md 템플릿(기능개요→기술설계→파일목록→단계→테스트)을 따른다 .

### Phase 1: 이벤트/보드 기본

* events CRUD
* 보드 페이지(검색/정렬/카테고리/페이지네이션)
* 좋아요 API 연결(기존 패턴) 

### Phase 2: 질문 입력/답변 편집

* admin 질문 직접 입력
* 질문 상세: Copy for LLM + Novel Editor 2개(Gemini/GPT) + 저장

### Phase 3: 엑셀 업로드 + Gemini 전처리

* 엑셀 파서(해더 자동 탐지: 순서/신청일시/이름/이메일/질문)
* raw_responses 저장
* Gemini 배치 전처리 후 questions upsert

### Phase 4: 그룹핑(수동) + 보드 그룹 모드

* 그룹/멤버십 테이블
* admin 그룹핑 UI(선택 바 + 모달)
* public grouped view(그룹 카드 → 펼쳐서 멤버 보기)

### Phase 5: 방송(OBS)

* broadcast_state
* Stage View(OBS) + Control View(운영)
* Realtime 구독으로 즉시 화면 반영

---

## 15. 테스트/검수(DoD)

### 데이터/회차 분리

* 서로 다른 event의 질문/좋아요/그룹/방송 상태가 섞이지 않는다

### 보드

* qna.html 수준의 UX(토스트/검색/정렬/카테고리/카드 렌더) 구현  
* 좋아요 중복 방지 + like_count 증가 정상(기존 RPC 로직) 
* 프롬프트 복사 버튼 "Copy for LLM"이 정상 동작(복사 성공 시 토스트)

### 엑셀 업로드

* 업로드 후 전처리된 질문이 생성(최대 3개 청킹)
* invalid 응답은 저장되지 않음
* 이름은 저장되되, 공개 화면에서는 마스킹 출력

### 그룹핑

* 수동 그룹 생성/추가/제거/대표 변경/병합 동작
* grouped/ungrouped 토글 정상

### 방송

* Stage View에 ON AIR/진행표시/질문/양쪽 답변 카드 렌더  
* Control에서 다음/이전/Space 공개가 broadcast_state에 반영되고 Stage가 즉시 업데이트(프로토타입의 공개/블러 해제 동작과 동일 컨셉) 

---

## 다음 액션(내가 바로 만들어줄 수 있는 것)

원하면 위 명세를 **Cursor가 더 잘 수행하도록 “작업 지시(프롬프트) 형태”로 PR 단위 6~8개**로 쪼개서 드릴게요. 예:

* PR1: DB migrations + RLS (modu_likes, modu_question_groups, modu_raw_responses, modu_broadcast_state)
* PR2: 보드 read API + 좋아요 API
* PR3: admin 질문/답변(Novel) + 프롬프트 복사 (Copy for LLM)
* PR4: 엑셀 업로드 + Gemini 전처리
* PR5: 그룹핑 UI + API
* PR6: 방송 Stage/Control + Realtime

원하시면 “현재 리포지토리 구조(이미 있는 코드/폴더)” 기준으로 파일 경로까지 딱 맞춰서 다시 써드릴게요.
